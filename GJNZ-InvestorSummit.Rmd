---
title: "Figures for GJ Net-Zero work"
author: "Aman Malik"
date: "2024-03-01"
output:
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
    theme: united
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = F,warning = F,cache = T)

```

## Installing required packages

If any packages are not installed, install them using `install.packages(package-name)`

```{r include=FALSE}
# Required packages
library(rgcam) # for getting data from database and reading it (see how to install rgcam below)
library(tidyverse) # for manipulating data and making plots
library(jgcricolors) # color scheme from JGCRI
library(ggsci) # additional color palettes
library(ggthemes) # themese to make nice plots 
library(ggpubr) # additional themes to make nice plots
library(patchwork) # to put multiple plots together
library(ggrepel) # for geom label repel
library(readxl) # to read and write excel files
library(extrafont)
#font_import() # need to do this only once, so uncomment and run once
loadfonts(device = "win")
#To install rgcam follow instructions:
#1. library(devtools)#devtools package should be installed for this to work
#2. devtools::install_github("JGCRI/rgcam",build_vignettes = TRUE,force = T)

#library(jgcricolors)



```

# Color Palette CEEW and font type
```{r}
my_custom_palette <- c("#575756", "#9d9d9c","#D5d7dc", "#C3E5F5", "#71c9eb", "#009cd8", "#8db824","#b4d48c")

theme_set(theme_pubclean(base_size = 16, base_family = "Calibri"))
```


```{r eval=FALSE, include=FALSE}
## Connecting to GCAM database and writing database output to a project file (.dat file), for specific queries


# This only needs to be run once or to add new scenarios to the project file
path <- 'D:/GCAM_State/output/' # change this path to where database is locally
conn <- localDBConn(path, 'database_basexdb')
queryFileInput <- 'queries.xml'
prj <- addScenario(conn, proj = 'GJNZ.dat', scenario =  c('BAU_GJ'), queryFile = queryFileInput,warn.empty = T,clobber = T) # This command runs queries from queryFileInput against the database, extracts the results for the metnioned scenarios (BAU_GJ) called and write the results to a file called "GJNZ.dat". 
scenarios <- listScenarios(prj)# to check which scenarios have been added
queries <- listQueries(prj)# to check all queries added
                   
```

```{r}
# If you have multiple .dat files, with different scenarios, then you can merge them together

prj <- mergeProjects("data/GJNZ_Ref_V3_2024_10_12.dat","data/GJNZ_NZ70_V3_2024_10_12.dat")

# prj <- mergeProjects("data/GJNZ_Reference_report.dat","data/GJNZ_NZ70_report.dat")



#prj <- dropScenarios(prj,"Net_Zero")

queries <- listQueries(prj)

#Renaming scenarios 

# Loop through each dataframe in the list
for (i in seq_along(queries)) {
  # Access the dataframe
  prj[["V3_Ref_Final_report"]][[queries[i]]][["scenario"]] <- "Reference"
  prj[["V3_NZ70_Final_report"]][[queries[i]]][["scenario"]] <- "Net_Zero"
  

  
}
# See functions below if you want to drop scenarios
# prj <- dropScenarios(prj,"ElecRail_ElecShwt_NZ70")
# prj <- dropScenarios(prj,"NZ-Ind_GJ-2070_ROW-2080")


```

# Socioeconomics
```{r}
gdp <- getQuery(prj,"GDP by region") %>% mutate(category="GDP")
pop <- getQuery(prj,"Population by region") %>% mutate(category="Pop")
gdpPc <- getQuery(prj,"PPP GDP by region") %>% mutate(category="GDPPC")

socioeco <- bind_rows(gdp,pop,gdpPc)# %>% filter(scenario=="BAU_GJ")

ggplot(socioeco %>% filter(region %in% c("GJ", "TN", "KA", "MH"), category == "Pop",year >2005,year<2075,scenario=="Reference"), mapping = aes(x = year, y = value / 1e3, color = region)) +
  geom_line(linewidth = 1.2) +
  geom_point(shape="circle",size=2)+
  geom_label_repel(socioeco %>% filter(region %in% c("GJ", "TN", "KA", "MH"), category == "Pop",year==2070,scenario=="Reference"), mapping = aes(x = year, y = value / 1e3, color = region,label = region),
    nudge_x = 6, box.padding = 0.3, direction = "y",
    na.rm = TRUE, show.legend = F,force_pull = 0.5)+
  geom_line() +  # Divide by 1e6 to convert to millions
  theme_pander(boxes = TRUE, base_size = 14) +
  scale_color_aaas() +
  scale_x_continuous(breaks = seq(2010, 2070, by = 10))+
      guides(color = "none")+
  labs(y = "Population (Millions)", x = "")


ggplot(socioeco %>% filter(region %in% c("GJ", "TN", "KA", "MH"), category == "GDPPC", year > 2005, year < 2075,scenario=="Reference"), 
       mapping = aes(x = year, y = value * 1000*1.98, color = region)) +
  geom_line(data = socioeco %>% filter(region %in% c("GJ", "TN", "KA", "MH"), category == "GDPPC", year > 2005, year <= 2020,scenario=="Reference"), 
            aes(x = year, y = value * 1000 * 1.98, color = region), 
            linetype = "solid", size = 1.2) +
  geom_point(shape="circle",size=2)+
  geom_line(data = socioeco %>% filter(region %in% c("GJ", "TN", "KA", "MH"), category == "GDPPC", year >= 2020, year < 2075,scenario=="Reference"), 
            aes(x = year, y = value * 1000*1.98, color = region), 
            linetype = "dashed", size = 1.2) +
   geom_label_repel(socioeco %>% filter(region %in% c("GJ", "TN", "KA", "MH"), category == "GDPPC",year==2070,scenario=="Reference"), mapping = aes(x = year, y = value*1000*1.98, color = region,label = region),
    nudge_x = 6, box.padding = 0.3, direction = "y",
    na.rm = TRUE, show.legend = F,force_pull = 0.5)+
  theme_pander(boxes = TRUE, base_size = 14) +
  scale_color_aaas() +
  scale_x_continuous(breaks = seq(2010, 2070, by = 10))+
      guides(color = "none")+
  labs(y = "GDP per capita (2020 USD)", x = "")

```





# Emissions
```{r}
# Removing biomass emissions, and aggregating according to sector
emi <- getQuery(prj,query = 'CO2 emissions by tech') %>% 
      filter(region=="GJ",year >2010, year < 2075,sector!="biomass liquids",subsector!="biomass") %>% 
  group_by(scenario,sector,year) %>% 
    summarise(value=sum(value)) %>% 
  mutate(sector = if_else(str_detect(sector, regex("enuse|process heat cement|oil refining", ignore_case = TRUE)), "Industry", sector)) %>%
  mutate(sector = if_else(str_detect(sector, regex("fsuse|cement", ignore_case = TRUE)), "IPPU", sector)) %>% 
  mutate(sector = if_else(str_detect(sector, regex("resid|comm", ignore_case = TRUE)), "Building", sector)) %>% 
   mutate(sector = if_else(str_detect(sector, regex("trn", ignore_case = TRUE)), "Transport", sector)) %>% 
mutate(sector = if_else(str_detect(sector, regex("electricity", ignore_case = TRUE)), "Power", sector)) %>% 
   group_by(scenario,sector,year) %>% 
    summarise(value=sum(value)) %>% 
  group_by(scenario, year) %>% 
  mutate(percent = value / sum(value), percent = percent * 100) %>% 
  ungroup()

# emi <- getQuery(prj,query = 'CO2 emissions by aggregate sector') %>%
#       filter(region=="GJ",year >2010, year < 2075) %>%
#     mutate(sector=mgsub::mgsub( sector,pattern = c("biomass liquids","oil refining"),replacement = c("Industry","Industry"))) %>% #Emissions
#   group_by(Units,scenario,region,sector,year) %>%
#   summarise(value=sum(value)) %>%
#   group_by(scenario, year) %>%
#   mutate(percent = value / sum(value), percent = percent * 100) %>%
#   ungroup()

writexl::write_xlsx(x = emi,"AggregateEmissions.xlsx")

emi$scenario <- factor(emi$scenario,levels = c("Reference","Net_Zero"))
emi_tot <- emi %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value*3.67))

annotate_data <- emi %>% 
  filter(year > 2005) %>%
  group_by(scenario, year) %>%
  summarize(total_value = sum(value * 3.67)) 

first_last_years <- annotate_data %>% 
  filter(year == min(year) | year == max(year))

##################################################
# Total emissions stacked area
ggplot()+
geom_area(data = emi %>% filter(year>2015),mapping=aes(x = year,y=value*3.67,fill=sector))+
  facet_wrap(~scenario)+
    #  theme_pubclean(base_size = 12)+
  scale_fill_manual(values = my_custom_palette)+
    #scale_fill_viridis_d()+
  labs(y = expression(Emissions~(MTCO[2])),x="")+
  scale_y_continuous(breaks = seq(0, 1200,by=200))

ggsave("output_plots/emissions.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
##################################
#Individual emissions facet wrap
ggplot()+
geom_line(data = emi %>% filter(year>2015),mapping=aes(x = year,y=value*3.67,color=sector,linetype=scenario,group=interaction(sector,scenario)),size=1.2)+
  facet_wrap(~sector,scales = "free")+
  scale_x_continuous(breaks = seq(2020, 2070, by = 10))+
  guides(color = guide_legend(nrow = 2),linetype=guide_legend(nrow=2))+
  #theme_pubclean(base_size = 12)+
   scale_color_manual(values = my_custom_palette[2:6])+
  labs(y=expression(Emissions~(MTCO[2])),x="")+
  theme(axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8))
   # geom_label(data = first_last_years, 
   #           aes(x = year, y = total_value, label = round(total_value, 0)),
   #           vjust = -0.2, hjust = 0.5, size = 3, fill = "white", color = "black")

ggsave("output_plots/sector_emissions.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
######################
######################  
ggplot(emi %>% filter(year %in% c(2020,2070)), 
       mapping = aes(x = "", y = percent, fill = sector, group = scenario)) +
  geom_col(color = "white", size = 1) +
  facet_grid(year~scenario) +
  geom_text(aes(label = ifelse(percent >= 6, paste0(round(percent, 0), "%"), "")),
            position = position_stack(vjust = 0.5),
            hjust = 1,  # Adjust hjust for label placement
            show.legend = FALSE) +
  #theme_void() +
  scale_fill_manual(values = my_custom_palette)+
  labs(y = "Share of emissions by sector")

ggsave("output_plots/emissions_share.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#######################
```

## Kaya Identity
```{r}
```{r}
# Population
# GDP per capita
# CO2 emissions
# Carbon Intensity
# Energy Intensity
# Carbon Intensity

gdp <- getQuery(prj,"GDP by region") %>% mutate(category="GDP") %>% 
  filter(region=="GJ") %>% select(scenario,year,value) %>% mutate(title="GDP")
pop <- getQuery(prj,"Population by region") %>% mutate(category="Pop")%>% 
  filter(region=="GJ") %>% select(scenario,year,value) %>% mutate(title="Population")
gdpPerCap <- getQuery(prj,"PPP GDP by region") %>% mutate(category="GDPPC")%>% 
  filter(region=="GJ") %>% select(scenario,year,value) %>% mutate(title="GDP Per capita")

emi_tot <- emi %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value*3.67)) %>% mutate(title="Emissions")

fe_tot <- fe %>% 
  select(-percent) %>% 
  group_by(year,scenario) %>% 
  summarise(value=sum(value))  mutate(title = "Final Energy (EJ)")%>%


carbon_intensity <- left_join(emi_tot, fe_tot, by = c("scenario", "year")) %>%
  mutate(value = value.x / value.y) %>%
  mutate(title = "Emissions intensity (CO2/Energy)")%>% 
  select(year, value, scenario,title)

en_intensity <- left_join(fe_tot, gdp, by = c("scenario", "year")) %>%
  mutate(title = "Energy intensity (Energy/GDP)") %>%
  mutate(value = value.x / value.y) %>% 
  select(year, value, scenario,title)

kaya <- gdpPerCap %>%
  bind_rows(emi_tot) %>%
  bind_rows(carbon_intensity) %>%
  bind_rows(en_intensity) %>%
  bind_rows(pop) 


kaya_ref <- kaya %>% filter(year == "2020")

kaya2 <- left_join(kaya, kaya_ref, by = c("title", "scenario")) %>%
  mutate(
    value = value.x / value.y,
    value = round(value, 2),http://127.0.0.1:46355/graphics/plot_zoom_png?width=1280&height=650
    title = gsub(x=title, replacement =  "Population", pattern = "population by region"))



ggplot()+
  geom_line(kaya2 %>% filter(year.x > 2015, year.x < 2075),mapping = aes(x = year.x, y = value, color = title,linetype=scenario),size=1.5)+
  facet_wrap(~scenario)+
  coord_cartesian(ylim = c(0, 10))+
   theme_pubclean(base_size = 12)+
    scale_color_viridis_d()
  

ggplot(kaya2 %>% filter(year.x > 2010, year.x < 2075)) %>% 
  geom_line(mapping = aes(x = year.x, y = value, color = title, group = title), linewidth = 1.2) 
geom_vline(xintercept = "2040",linetype=3)+
  annotate(geom = "text",x = "2030",y=6,label="Year of emissions peak")+
  geom_curve(
  aes(x = "2035", y = 5.8, xend = "2040", yend = 5),color="grey",
    arrow = arrow(length = unit(0.03, "npc")))+
  geom_point(aes(x=year.x,y=value,color=title),shape="circle",size=2)+
  theme_pander(boxes = T,base_size = 14)+
  scale_color_manual(values = mypal[names(mypal) %in% unique(kaya2$title)]) +
  labs(x = "", y = "Change rel. to 2015") +
  theme(legend.position = c(0.25, 0.8), legend.title = element_blank(), legend.box.background = element_rect(colour = "black"))+
   scale_y_continuous(breaks = seq(1, 9, by = 2))+
  scale_x_discrete(breaks=seq(2020,2070,10))

ggsave("output_plots/kaya.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```


# Emission Intensity (MtCo2/GDP)
```{r}
tot_emissions <-  getQuery(prj,query = 'CO2 emissions by aggregate sector') %>% 
      filter(region=="GJ",year >2000, year < 2075,) %>% 
  group_by(scenario, year) %>% 
  mutate(percent = value / sum(value), percent = percent * 100) %>% 
  ungroup() %>% 
  group_by(scenario, year) %>%
  summarize(total_value = sum(value * 3.67)) 
#%>% 
 # filter(scenario=="Revised_NZ70")

gdp_gj <- getQuery(prj,"GDP by region") %>% mutate(category="GDP") %>% filter(region=="GJ",year > 2000)                                                         

ei <- left_join(tot_emissions,gdp_gj,by=c("year","scenario")) %>% 
  mutate(ei=total_value/value,year=as.factor(year))

writexl::write_xlsx(x = ei,"emission_intensity.xlsx")
```

# Emission intensity of Energy (MtCo2/EJ)
```{r}
fe3 <- getQuery(prj,"final energy consumption by aggregate sector and fuel") %>% 
  filter(region=="GJ") %>%
  mutate(sector=mgsub::mgsub( sector,pattern = c("Agriculture"),replacement = c("Industry"))) %>% 
  group_by(scenario,sector,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() 
  

emi <- getQuery(prj,query = 'CO2 emissions by aggregate sector') %>% 
      filter(region=="GJ",year >2010, year < 2075) %>% 
    mutate(sector=mgsub::mgsub( sector,pattern = c("biomass liquids","oil refining","IPPU"),replacement = c("Industry","Industry","Industry"))) %>% 
  group_by(Units,scenario,region,sector,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
  mutate(value=value*3.67) %>% 
  select(-Units,-region)

energy_intensity <- left_join(fe3,emi,by=c("scenario","year","sector")) %>% filter(year>2010) %>% 
  mutate(eni=value.y/value.x)

writexl::write_xlsx(energy_intensity,"energy_intensity.xlsx")
energy_intensity <- readxl::read_excel("energy_intensity.xlsx")

#######################
ggplot()+
  geom_line(energy_intensity %>% filter(year>2015),mapping=aes(x=year,y=eni,linetype=scenario,color=sector))+
  theme_pander(boxes = T,base_size = 14)+
  scale_fill_aaas()+
  labs(y="Emission intensity of energy (MtCO2/EJ)",x="")

ggsave("output_plots/emission_intensity_of_energy.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
####################
```

# Energy intensity of GDP

```{r}
gdp_gj <- getQuery(prj,"GDP by region") %>% mutate(category="GDP") %>% filter(region=="GJ",year > 2010)      %>% 
  select(year,scenario,value) %>% 
  mutate(value=(value*1.98)/1000)

fe_tot <- getQuery(prj,"final energy consumption by aggregate sector and fuel") %>% 
  filter(region=="GJ",year>2010) %>%
  select(year,scenario,value) %>% 
group_by(year,scenario) %>% 
  summarise(value=sum(value)) 

enint_gdp <- left_join(fe_tot,gdp_gj,by=c("year","scenario")) %>% 
  mutate(enint_gdp=value.x/value.y)

writexl::write_xlsx(enint_gdp,"energy_intensity2.xlsx")
enint_gdp <- readxl::read_excel("energy_intensity2.xlsx")

#######################
ggplot()+
  geom_line(enint_gdp %>% filter(year>2015),mapping=aes(x=year,y=enint_gdp*1000,linetype=scenario))+
  theme_pander(boxes = T,base_size = 14)+
  scale_fill_aaas()+
  labs(y="Energy intensity of GDP (PJ/2020billion$)",x="")+
   scale_y_continuous(breaks = seq(0, 12, by = 1))

ggsave("output_plots/emission_intensity_of_energy.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
####################

```



# Electricity

## Electricity consumption/demand
```{r}
elec <- getQuery(prj,"final energy consumption by aggregate sector and fuel") %>% 
  filter(region=="GJ",input=="electricity") %>% 
  group_by(scenario,sector,year) %>% 
    summarise(value=sum(value)) %>% 
  group_by(year,scenario) %>% 
  mutate(percent=value/sum(value),percent=percent*100)



#writexl::write_xlsx(elec,"elec.xlsx")
elec <- read_xlsx("elec.xlsx") %>% select(-percent) %>% 
  group_by(year,scenario) %>% 
  mutate(percent=value/sum(value),percent=percent*100) %>% 
ungroup()

elec_tot <- elec %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value*277.78))

elec$scenario <- factor(elec$scenario, levels = c("Reference", "Net_Zero"))

#########################################
ggplot()+
geom_area(elec %>% filter(year>2015), mapping=aes(x=year, y=value*277.78, fill=sector))+
  facet_wrap(~scenario)+ 
   #    theme_pubclean(base_size = 12)+
    scale_fill_manual(values = my_custom_palette)+
  labs(y="Electricity consumption (Billion Units)",x="")+
   scale_y_continuous(breaks = seq(0, 4500, by = 500))
  
ggsave("output_plots/elec_demand.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#####################################
######################################
ggplot(elec %>% filter(year %in% c(2020, 2030, 2050, 2070)),mapping=aes(x=as.factor(year),y=percent,fill=sector))+
  geom_bar(stat = "identity")+
  facet_wrap(~scenario) +
    theme_pubclean(base_size = 12)+
    scale_fill_viridis_d()+
  labs(y = "Sectoral share (%)", x = "")+
  geom_text(aes(label = ifelse(percent > 5, paste0(round(percent, 0), "%"), "")), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
  coord_cartesian(ylim = c(0, 12))

ggsave("output_plots/elec_demand_share.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

  
##################################

alpha_values  <- c("Reference"=0.7, "Net_Zero" = 1)


ggplot()+
  geom_col(elec %>% filter(year>2015) %>% mutate(year=as.factor(year)),mapping=aes(x=year,y=value*277.78,fill=sector,alpha=scenario,group=interaction(year,scenario)))
  facet_grid(~year)
       theme_pubclean(base_size = 12)+
    scale_fill_viridis_d()
  scale_alpha_manual(values=alpha_values)+
  labs(y="Electricity consumption (Billion Units)",x="")
   scale_x_continuous(breaks = seq(2020, 2070, by  = 10))
   scale_y_continuous(breaks = seq(0, 4500, by = 500))
 

```



## Electricity Generation
```{r}
elec_gen <- getQuery(prj,"elec gen by subsector") %>% 
  filter(region=="GJ",year>2010)


elec_gen <- elec_gen %>% 
  mutate(value=if_else(scenario=="Reference" & subsector=="gas",value-0.0419,value)) %>% 
    mutate(value=if_else(scenario=="Reference" & subsector=="coal",value+0.0419,value)) %>%
  mutate(value=if_else(scenario=="Net_Zero" & subsector=="gas" & year<2045,value-0.0419,value)) %>% 
    mutate(value=if_else(scenario=="Net_Zero" & subsector=="coal" & year<2045,value+0.0419,value)) %>%
  group_by(scenario,year) %>% 
  mutate(percent=(value/sum(value))*100)

elec_gen$scenario <- factor(elec_gen$scenario,levels = c("Reference","Net_Zero"))

elec_gen_ren <- elec_gen %>% 
  filter(subsector %in% c("solar","wind","hydro","biomass")) %>% 
  select(-value) %>% 
  summarise(percent=sum(percent)) %>% 
  mutate(subsector="RE")

elec_gen_share <- elec_gen %>% select(-value,-output,-region) %>% 
  bind_rows(elec_gen_ren)

elec_gen_share$scenario <- factor(elec_gen_share$scenario, levels = c("Reference", "Net_Zero"))

elec_gen_share$subsector <- factor(elec_gen_share$subsector, levels = c("coal", "gas","solar","wind","hydro","nuclear","biomass","refined liquids","RE"))
  
elec_gen_tot <- elec_gen %>% 
  group_by(year,scenario) %>% 
  summarise(value=sum(value)*277.78)

writexl::write_xlsx(elec_gen %>% filter(year>2015),"elec_gen.xlsx")
########################
ggplot()+
geom_area(elec_gen %>% filter(year>2015),mapping=aes(x=year,y=value*277.78,fill=subsector))+
  facet_wrap(~scenario) +
 #theme_pubclean(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  labs(y="Electricity Generation (Billion Units)",x="")+
 scale_y_continuous(breaks = seq(0,2500, by = 200))
  

ggsave("output_plots/elec_generation.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
###########################
  ggplot()+
  geom_line(elec_gen_share %>% filter(year %in% c(2020,2030,2040,2050),subsector %in% c("coal","gas","solar","wind")), mapping=aes(x=year,y=percent,color=subsector,linetype=scenario,group=interaction(scenario,subsector)),size=1.2)+
  # geom_point(elec_gen_share %>% filter(year>2015,year<2055,subsector %in% c("coal","gas","solar","wind")), mapping=aes(x=year,y=percent,color=subsector,group=interaction(scenario,subsector)),size=3)+
  geom_line(elec_gen_share %>% filter(year %in% c(2020,2030,2040,2050),subsector=="RE"), mapping=aes(x=year,y=percent,linetype=scenario,color=subsector,group=interaction(scenario,subsector)),size=0.5)+
  
  #facet_wrap(~scenario) +
  labs(y = "Share of power generation (%)", x = "Year")+
 #theme_pubclean(base_size = 14)+
    scale_color_manual(values = my_custom_palette[3:8])+
  theme(legend.position = "top",
        #axis.text.x = element_text(size = 9, angle = 45, vjust = 0.8, hjust = 0.8)
        )+
guides(color = guide_legend(nrow = 2),linetype=guide_legend(nrow=2))+
   coord_cartesian(ylim = c(0, 100))+
    labs(x="")
  scale_x_continuous(breaks = seq(2020, max(elec_gen$year), by = 10)) 

# 
#   geom_text(aes(label = ifelse(percent > 5, paste0(round(percent, 0), "%"), "")), 
#             position = position_stack(vjust = 0.5), 
#             size = 3) +
#  

ggsave("output_plots/elec_generation_share.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

writexl::write_xlsx(elec_gen_share %>% filter(year>2015,subsector %in% c("coal","gas","solar","wind","RE")),"elec_gen_share.xlsx")
##################################

```


## Cumulative Capacity and Capacity Addition
```{r}
elec_cap <-  read_excel("data/RV-GJNZ Transport analysis.xlsx", 
    sheet = "Sheet1") %>% 
  pivot_longer(2:10,names_to = "subsector",values_to = "value")

elec_cap$scenario <- factor(elec_cap$scenario, levels = c("Reference", "Net_Zero"))
 ################
# Capacity Addition
a <- ggplot()+
  geom_col(elec_cap %>% filter(year!="2015-2020",subsector %in% c("solar PV","coal","wind onshore"),variable=="new"),mapping=aes(y=year,x=value,fill=scenario,group=interaction(subsector,scenario)),position = position_dodge())+
  facet_grid(~subsector,scales = "free")+
  theme_pubclean(base_size = 14,flip = T)+
    scale_fill_manual(values = my_custom_palette)+
  labs(y="",x="Capacity addition (GW)")+
  guides(fill = guide_legend(title = NULL))

ggsave("output_plots/elec_cap_addition.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#################################
#########################
# Cumulative Capacity
b <- ggplot()+
geom_col(elec_cap %>% filter(year>2010,variable=="cumulative",subsector!="solar CSP"),mapping=aes(x=value,y=year,fill=subsector))+
  facet_wrap(~scenario) +
 theme_pubclean(base_size = 14,flip = T)+
    scale_fill_manual(values = my_custom_palette)+
  labs(x="Cumulative Capacity (GW)",y="")+
  guides(fill = guide_legend(title = NULL))
 #scale_y_continuous(breaks = seq(0,2500, by = 200))


ggsave("output_plots/elec_cum_cap.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
##################


b/a

ggsave("output_plots/elec_cap_plots_combined.png",
  device = "png", dpi = "print",
  width = 8, height = 8
)

```


# Final Energy Consumption
```{r}
fe <- getQuery(prj,"final energy consumption by sector and fuel") %>% 
  filter(region=="GJ",year>2010) %>% 
  mutate(input=gsub(x = input,pattern="elect_td_res|elect_td_com",replacement="electricity")) %>% 
  group_by(scenario,input,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
 # mutate(scenario="BAU_GJ") %>% 
  group_by(year,scenario) %>% 
  mutate(percent=value/sum(value),percent=percent*100)

fe_tot <- fe %>% 
  select(-percent) %>% 
  group_by(year,scenario) %>% 
  summarise(value=sum(value))

fe$scenario <- factor(fe$scenario,levels = c("Reference","Net_Zero"))

##################################
a <- ggplot()+
geom_area(fe %>% filter(year>2015,year<2075),mapping=aes(x=year,y=value,fill=input))+
  
  facet_wrap(~scenario) +
  # theme_pubclean(base_size = 14)+
   scale_fill_manual(values = my_custom_palette)+
  labs(y="Final Energy Consumption mix (EJ)",x="")+
 scale_y_continuous(breaks = seq(0, 20, by = 2))
#   theme(legend.position = "top", 
#         legend.box = "horizontal",
#         legend.box.just = "center",
#         legend.spacing.x = unit(0.5, 'cm'),
#         legend.title = element_blank()) +
#   guides(fill = guide_legend(nrow = 2))
  
ggsave("output_plots/final_energy_fuel_mix.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

writexl::write_xlsx(fe %>% filter(year %in% c(2020, 2050, 2070)),"fe_shares.xlsx")

###########################
###########################
b <- ggplot(fe %>% filter(year %in% c(2020, 2050, 2070)),mapping=aes(x=as.factor(year),y=percent,fill=input))+
  geom_bar(stat = "identity")+
  facet_wrap(~scenario) +
 # theme_minimal()+
  labs(y = "Share of fuels (%)", x = "Year")+
  #theme_pubclean(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  geom_text(aes(label = ifelse(percent > 5, paste0(round(percent, 0), "%"), "")), 
            position = position_stack(vjust = 0.5), 
            size = 3,color="black") +
  coord_cartesian(ylim = c(0, 100))+labs(x="")

ggsave("output_plots/final_energy_fuel_mix_share.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

a/b + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a")

ggsave("output_plots/FE_fuel_total_and_share.png",
  device = "png", dpi = "print",
  width = 9, height = 10
)

#########################
###########################

fe3 <- getQuery(prj,"final energy consumption by aggregate sector and fuel") %>% 
  filter(region=="GJ") %>%
  group_by(scenario,sector,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,scenario) %>% 
  mutate(percent=value/sum(value),percent=percent*100)

fe3$scenario <- factor(fe3$scenario, levels = c("Reference", "Net_Zero"))

#########################
ggplot()+
geom_area(fe3 %>% filter(year>2010,year<2075),mapping=aes(x=year,y=value,fill=sector,group=sector))+
  facet_wrap(~scenario) +
  #theme_pander(boxes = T,base_size = 14)+
  scale_fill_manual(values = my_custom_palette)+
  labs(y="Final Energy Consumption by enduse (EJ)",x="")+
scale_y_continuous(breaks = seq(0, 20, by = 2))

ggsave("output_plots/final_energy_sector_mix.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
###########################

ggplot(fe3 %>% filter(year %in% c(2020, 2030, 2050, 2070)),mapping=aes(x=as.factor(year),y=percent,fill=sector))+
  geom_bar(stat = "identity")+
  facet_grid(~scenario)+
  theme_minimal()+
  labs(y = "Share of sector (%)", x = "Year")+
   scale_fill_manual(values = my_custom_palette)+
 # theme_pander() +
  geom_text(aes(label = ifelse(percent > 5, paste0(round(percent, 0), "%"), "")), 
            position = position_stack(vjust = 0.5), 
            size = 3) +
  coord_cartesian(ylim = c(0, 100))+labs(x="")

  ggsave("output_plots/final_energy_sector_mix_share.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#################################
#################################
  
fe4 <- fe3 %>% 
  filter(year %in% c(2020,2070)) %>% select(-percent) %>% 
  pivot_wider(names_from = year,values_from = value) %>% 
  mutate(increase=`2070`/`2020`)

  # note that agri demand needs to be corrected manually in 2020
ggplot()+
  geom_col(fe4 %>% filter(scenario=="Reference"),mapping=aes(x=sector,y=increase,fill=sector))+
  scale_fill_manual(values = my_custom_palette)+
  theme_pander()+
  labs(x="",y="Increase in demand (2070/2020")
  
 ggsave("output_plots/FE_demand_increase.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#################################### 
```

# Transport
```{r}
trans <- getQuery(prj,query = "transport service output by mode") %>% 
  filter(region=="GJ",year>2010) %>% 
  filter(!mode %in% c("LDV_2W","LDV_4W","LDV","road")) %>% 
  mutate(mode=mgsub::mgsub(mode,
  pattern = c("Air Domestic","Air International","Bus","HSR","LDV_3W","Passenger Rail","Cycle","Walk"),
                          replacement = c("Aviation","Aviation","Bus","Rail","3W","Rail","NMT","NMT"))) %>% 
  mutate(category=if_else(mode%in% c("2W","3W","4W","Aviation","Bus","NMT","Rail"),"Passenger","Freight")) %>% 
  group_by(scenario,year,mode,category) %>% 
    summarise(value=sum(value)) %>% 
  ungroup()  

trans_tot <- trans %>% 
  group_by(scenario,year,category) %>% 
  summarise(value=sum(value))

writexl::write_xlsx(trans,"transport_demand.xlsx")


##########################
#Passenger and Freight
a <- ggplot()+
geom_area(trans %>% filter(year>2015,!mode %in% c("Ship Domestic","Ship International","Aviation"),scenario=="Reference"),mapping=aes(x=year,y=value/1000,fill=mode,group=interaction(mode,scenario)))+
  facet_wrap(~category,scales = "free") +
      scale_fill_manual(values = my_custom_palette)+
   theme(axis.text.x = element_text(size = 12, angle = 45, vjust = 0.8, hjust = 0.8))+
  labs(y="Service Demand (billion tonne-km or billion pass-km)",x="")

ggsave("output_plots/transport_pass_freight_mode_demand.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
##########################
trans_share_pass <- trans %>%  
filter(category=="Passenger",!mode %in% c("Aviation"),year>2010) %>% 
  group_by(year,scenario) %>% 
  mutate(share=value/sum(value),
         share=share*100)

writexl::write_xlsx(trans_share_pass,"trans_share_pass.xlsx")
##########################
b <- ggplot(trans_share_pass %>% filter(year %in% c(2020,2050,2070),scenario=="Reference"),mapping = 
       aes(x = "", y = share, fill = mode, group = scenario)) +
  geom_col(size = 1,show.legend = F) +
  facet_grid(.~year)+
  geom_text(data = . %>% filter(share > 5),
    aes(label = paste0(round(share, 0), "%")),
            position = position_stack(vjust = 0.7),
            hjust = 0.5,  # Adjust hjust for label placement
              size=3,color="white")+
       scale_fill_manual(values = c("2W"="#575756","3W"="#9d9d9c","4W"="#D5d7dc","Bus"="#C3E5F5","NMT"="#009cd8","Rail"="#8db824"))+
  #scale_fill_manual(values = my_colors)+
  labs(y = "Passenger modal share",x="")
##########################

a/b + plot_layout(guides = "collect")+plot_annotation(tag_levels = "a")&theme(legend.position = "top")

ggsave("output_plots/pass_transport_modal_share.png",
  device = "png", dpi = "print",
  width = 9, height = 10
)

############################

trans_fuel <- getQuery(prj,"transport final energy by fuel") %>% 
  filter(region=="GJ",year>2010) %>% mutate(scenario=as.factor(scenario)) %>% 
  group_by(scenario,year) %>% 
  mutate(percentage=(value/sum(value))*100)

trans_fuel_tot <- trans_fuel %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value))

trans_fuel$scenario <- factor(trans_fuel$scenario, levels = c("Reference", "Net_Zero"))

writexl::write_xlsx(trans_fuel,"trans_fuel.xlsx")

ggplot()+
geom_area(trans_fuel %>% filter(year>2015,year<2075,input!= "hydrogen"),mapping=aes(x=year,y=value,fill=input,group=interaction(input)))+
  
  facet_wrap(~scenario) +
    scale_fill_manual(values = my_custom_palette)+
  labs(y="Energy demand by fuel (EJ)",x="")+
  ylim(0,1.5)

ggsave("output_plots/transport_fuel.png",
  device = "png", dpi = "print",
  width = 8, height = 5
)

## Transport final energy by mode and fuel

trn_mode_fuel <- getQuery(prj,query = "transport final energy by mode and fuel") %>% 
  filter(region=="GJ",year>2015)

trn_mode_fuel_share <- trn_mode_fuel %>% 
  group_by(scenario,year,mode) %>%
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,scenario) %>% 
  mutate(percentage=(value/sum(value))*100)


```

# Buildings
```{r}
build <- getQuery(prj,"building final energy by service (Cooking) and fuel") %>%   filter(region=="GJ",sector=="Cooking",year>2010) %>% 
  group_by(scenario,input,year) %>% 
  summarise(value=sum(value))

##########################
ggplot()+
geom_area(build %>% filter(year>2010,year<2075),mapping=aes(x=year,y=value,fill=input))+
  facet_wrap(~scenario) +
  #theme_pander(boxes = T,base_size = 14,lp = "bottom")+
  scale_fill_manual(values = my_custom_palette)+
  labs(y="Cooking energy demand (EJ)",x="")

ggsave("output_plots/BUILDING_cooking.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

##########################

build4 <- getQuery(prj,"building total final energy by aggregate service") %>% 
  filter(region=="GJ") %>% 
  group_by(year,scenario) %>% 
  mutate(percent=(value/sum(value))*100)
  
build4$scenario <- build4$scenario <- factor(build4$scenario, levels = c("Reference", "Net_Zero"))

build4_tot <- build4 %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value))

writexl::write_xlsx(build4,"building_service.xlsx")

#######################
ggplot()+
geom_area(build4 %>% filter(year>2015,!sector %in% c("Heating","Others")),mapping=aes(x=year,y=value,fill=sector))+
  facet_wrap(~scenario) +
    scale_fill_manual(values = my_custom_palette)+
  labs(y="Energy Demand by Subsector (EJ)",x="")+
  scale_y_continuous(limits = c(0,1.5))

ggsave("output_plots/BUILDING_service.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
###################################
#####################################
blah <- build4 %>% select(-percent) %>% 
  filter(year %in% c(2020,2070), scenario=="Reference",!sector%in% c("Heating","Others")) %>% 
  pivot_wider(names_from = year,values_from = value) %>% 
  mutate(increase=`2070`/`2020`) 

ggplot()+
  geom_col(blah, mapping=aes(x=sector, y=increase,fill=sector))+
  #facet_wrap(~sector)+
 # theme_pander(boxes = T,base_size = 14,lp = "bottom")+
  scale_fill_manual(values = my_custom_palette)+
  labs(y="increase (2070/2020)",x="")

ggsave("output_plots/energy_increase.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

#########################################

build6 <- getQuery(prj,"building final energy by fuel") %>% filter(region=="GJ") %>% 
  group_by(scenario,year) %>% 
  mutate(percent=(value/sum(value))*100)

build6$scenario <- factor(build6$scenario, levels = c("Reference", "Net_Zero"))

writexl::write_xlsx(build6,"build_fuels.xlsx")

################################
a <- ggplot()+
geom_area(build6 %>% filter(year>2015),mapping=aes(x=year,y=value,fill=input))+
  facet_wrap(~scenario) +
  #theme_pubclean(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  labs(y="Building energy demand by fuel (EJ)",x="")

ggsave("output_plots/BUILDING_fuel.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

###################################
###################################

b <- ggplot(build6 %>% filter(year %in% c(2020, 2050, 2070)),mapping=aes(x=as.factor(year),y=percent,fill=input))+
  geom_bar(stat = "identity",show.legend = F)+
  facet_wrap(~scenario) +
  #theme_minimal()+
  labs(y = "Share of fuels (%)", x = "Year")+
   scale_fill_manual(values = my_custom_palette)+
#  theme_pander() +
  geom_text(aes(label = ifelse(percent > 5, paste0(round(percent, 0), "%"), "")), 
            position = position_stack(vjust = 0.5), 
            size = 3,color="white") +
  coord_cartesian(ylim = c(0, 100))+labs(x="")

ggsave("output_plots/BUILDING_fuel_share.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

a/b + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a")

ggsave("output_plots/building_fuel_total_and_share.png",
  device = "png", dpi = "print",
  width = 9, height = 10
)

#######################################
floorspace <- getQuery(prj,"Building floorspace") %>% 
  filter(region=="GJ") %>%  group_by(scenario, building) %>%
  mutate(normalized_value = value / value[year == 2020])

ggplot(floorspace %>% filter(year>2015,year<2075),mapping=aes(x=year,y=normalized_value,color=building,group = building))+
  geom_line(size=1)+
 # geom_point(aes(x = min(year), y = 1), size = 3, shape = 16, color = "black") +  # Sphere at starting point
 # geom_point(aes(x = max(year), y = normalized_value), size = 3, shape = 16, color = "black") +  # Spheres at the end points
  
   scale_x_continuous(breaks = c(2020, 2070), labels = c("2020", "2070")) +
    theme_pander(boxes = T,base_size = 14,lp = "bottom")+
  scale_fill_cosmic()+labs(y="Increase in floorspace")

ggsave("output_plots/building_floorspace.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

```


# Industry
```{r}
industry <- getQuery(prj,"final energy consumption by sector and fuel") %>% 
  filter(region=="GJ") %>% 
  filter(!str_detect(sector, "trn|resid|comm|fsuse")) %>% 
  group_by(scenario,input,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,scenario) %>% 
   mutate(percent = value / sum(value), percent = percent * 100) %>% 
   ungroup()

industry_tot <- industry %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value)) 

writexl::write_xlsx(industry,"industry_FE.xlsx")


industry$scenario <- factor(industry$scenario, levels = c("Reference", "Net_Zero"))

########################################
a <- ggplot()+
geom_area(industry %>% filter(year>2015),mapping=aes(x=year,y=value,fill=input))+
  facet_wrap(~scenario) +
  scale_fill_manual(values = my_custom_palette)+
    #scale_fill_viridis_d()+
  labs(y="Industry energy demand by fuel (EJ)",x="")+
 #coord_cartesian(ylim = c(0, 12.5))+
     scale_y_continuous(breaks = seq(0, 12, by = 2))

  ggsave("output_plots/industry_fuel.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#####################

b <- ggplot(industry %>% filter(year %in% c(2020, 2050, 2070)),mapping=aes(x=as.factor(year),y=percent,fill=input))+
  geom_bar(stat = "identity")+
  facet_wrap(~scenario) +
 scale_fill_manual(values = my_custom_palette)+
#    scale_fill_viridis_d()+
  labs(y = "Share of fuels (%)", x = "Year")+
  

  geom_text(aes(label = ifelse(percent > 5, paste0(round(percent, 0), "%"), "")), 
            position = position_stack(vjust = 0.5), 
            size = 3,color="white") +
  coord_cartesian(ylim = c(0, 100))+labs(x="")

ggsave("output_plots/industry_fuel_share.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)


a/b + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a")

ggsave("output_plots/industry_fuel_total_and_share.png",
  device = "png", dpi = "print",
  width = 9, height = 10
)


#################################

industry3 <- getQuery(prj,"final energy consumption by sector and fuel") %>% 
 filter(region=="GJ") %>% 
  filter(!str_detect(sector, "trn|resid|comm|_fsuse")) %>% 
  group_by(scenario,sector,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup()%>% mutate(scenario="BAU_GJ")

ggplot()+
geom_area(industry3 %>% filter(year>2015),mapping=aes(x=year,y=value,fill=sector))+
  facet_wrap(~scenario) +
  theme_pander(boxes = T,base_size = 14,lp = "bottom")+
  scale_fill_ucscgb()+
  labs(y="Industry Final energy demand by energy use sector (EJ)",x="")

######################################3

industry5 <- getQuery(prj,"final energy consumption by sector and fuel") %>% 
 filter(region=="GJ") %>% 
  filter(!str_detect(sector, "trn|resid|comm|_enuse|process heat cement|cement")) %>% 
  group_by(scenario,sector,year) %>% 
  summarise(value=sum(value)) %>% 
  ungroup()

ggplot()+
geom_area(industry5 %>% filter(year>2010),mapping=aes(x=year,y=value,fill=sector))+
  facet_wrap(~scenario) +
  theme_pander(boxes = T,base_size = 14,lp = "bottom")+
  scale_fill_aaas()+
  labs(y="Industry Final energy demand by fuel (EJ)",x="")

```

# Agriculture

```{r}
agri <- getQuery(prj,"Agriculture final energy by service and fuel") %>% 
  filter(region=="GJ",year>2010) %>% 
   group_by(scenario,year) %>% 
  mutate(percentage=(value/sum(value))*100)

writexl::write_xlsx(agri,"agri.xlsx")
agri <- read_excel("agri.xlsx") %>% 
   group_by(scenario,year) %>% 
  mutate(percentage=(value/sum(value))*100)

agri_tot <- agri %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(value)) %>% 
  filter(year>2015)


##########################
ggplot()+
geom_area(agri %>% filter(year>2015,scenario=="Reference"),mapping=aes(x=year,y=value,fill=input))+
 # facet_wrap(~scenario) +
 #theme_pubclean(base_size = 14)+
    scale_fill_manual(values = my_custom_palette)+
  labs(y="Agricultural energy demand (EJ)",x="")

ggsave("output_plots/agri_demand.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
#############################
```

# New Scenario
```{r}
new_scen <- read_delim("data/new-scen.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% 
  pivot_longer(cols = 3:13,names_to = "Year",values_to = "Value") 

z <- ggplot(data = new_scen %>% 
  filter(Year %in% c(2035,2045,2070)))+
  geom_col(mapping=aes(x = scenario,y=Value,fill=subsector,group=interaction(scenario,subsector)),position = position_dodge(width = 0.85))+
 geom_text(mapping=aes(x = scenario,y = Value, fill = subsector, label = ifelse(Value > 1, paste0(Value, "%"), ""),group=interaction(scenario,subsector,Year)), position = position_dodge2(width = 0.85), size = 3, color = "black",vjust = -0.5,hjust=0.4)+
  facet_grid(~Year)+
  scale_fill_manual(values = my_custom_palette[3:8])+
 # theme_pander()+
  labs(x="",y="Share (in %)")+
  expand_limits(y=c(0,80))
  
ggsave("output_plots/new-ccs-scen.png",
  device = "png", dpi = "print",
  width = 6, height = 5
)

```

## coal gen comparison
```{r}
coal_gen <- read_delim("data/coal-gen.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% 
  pivot_longer(cols = 2:13,names_to = "Year",values_to = "Value") %>% 
  mutate(Year=as.numeric(Year))

x <- ggplot(coal_gen)+
  geom_line(mapping=aes(x=Year,y=Value,color=Scenario,group=interaction(Scenario)),size=1)+
  scale_x_continuous(breaks = c(2020,2030,2040,2050,2060,2070))+
  scale_color_manual(values = my_custom_palette[4:5])+
  labs(x="",y= "Total coal generation (EJ)")

ggsave("output_plots/coal-gen-comp.png",
  device = "png", dpi = "print",
  width = 6, height = 4
)


z/x + plot_annotation(tag_levels = 'a')
ggsave("output_plots/combined-new-scen.png",
  device = "png", dpi = "print",
  width = 8, height = 8
)


```

